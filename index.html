<html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fix It</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kylefox/jquery-tablesort@master/jquery.tablesort.js"></script>


    <style>
        table {
            table-layout: fixed;
            width: 25%;
            text-align: left;
        }

        thead th:nth-child(1) {
            width: 10%;
        }

        thead th:nth-child(2) {
            width: 25%;
        }

        thead th:nth-child(3) {
            width: 65%;
        }

        th, td {
            margin: 4px;
            border: 0.5px solid black;
        }

        div {
            margin-top: 10px;
            margin-bottom: 10px;
        }
    </style>

</head>
<body>

<div>
    <textarea placeholder="Fix goes here" id="rawFix" rows="4" cols="50"></textarea>
</div>

<div>
    <button id="parseFixButton">Parse</button>
    <button id="clearButton">Clear</button>
    <button id="sampleButton">Sample</button>
</div>
<div>
    <div id="results_table"></div>
</div>

<script type="text/javascript">
    let self;

    function isValdEscapeCharacter(input_string) {
        return input_string.match(/^[0-9a-z]+$/) != null && input_string !== '.' && input_string !== '='
    }

    function guessFixVersion(fix) {
        return fix.substring(6, 9)
    }

    function getEscapeCharacter(fix) {
        let escp_guess = fix.substring(9, 10)
        if (escp_guess === '^') {
            escp_guess = fix.substring(9, 11)
        } else if (isValdEscapeCharacter(escp_guess)) {
            if (escp_guess === '^') {
                escp_guess = fix.substring(9, 11)
            } else if (fix.indexOf('^')) {
                escp_guess = '^'
            } else if (fix.indexOf('|')) {
                escp_guess = '|'
            } else if (fix.indexOf('~')) {
                escp_guess = '~'
            } else {
                alert('Unble to determine field separator. Results Try using : \u0001,^,|,~,')
                return null;
            }
        }
        console.log('Using separator : ' + escp_guess)
        return escp_guess;
    }

    function generateTable(rows_to_add) {
        let $table = $('<table>');
        $table.append('<thead>').children('thead')
            .append('<tr />').children('tr').append('<th>Tag</th><th>Name</th><th>Value</th>');
        let $tbody = $table.append('<tbody />').children('tbody');

        rows_to_add.forEach(function (row) {
            $tbody.append('<tr title=\"' + row.data.desc + '\"/>').children('tr:last')
                .append("<td>" + row.key + "</td>")
                .append("<td>" + row.data.name + "</td>")
                .append("<td>" + row.val + "</td>");

        })

        $('#results_table').empty()
        $table.appendTo('#results_table');
        $table.tablesort();
    }


    $(function () {
        self = this;

        self.parse_fix = function (escape_char, raw_fix, fix_fields) {
            let results_rows = []
            let fields = raw_fix.split(escape_char)
            fields.forEach(function (field) {
                let field_val = field.split("=")
                let desc = '';
                if (field_val[0] in fix_fields) {
                    desc = fix_fields[field_val[0]];
                }
                let found_field = {
                    key: field_val[0],
                    val: field_val[1],
                    data: desc
                }
                results_rows.push(found_field);
            })
            generateTable(results_rows)
        }

        $("#parseFixButton").on("click", function () {
            let raw_fix = $("#rawFix").val().trim()
            let fix_ver = guessFixVersion(raw_fix)
            $.getScript("https://cdn.jsdelivr.net/gh/noahkeen/fixit@main/js/fixFields_" + fix_ver + ".js", function (data) {
                let escape_char = getEscapeCharacter(raw_fix)
                if (!escape_char) return;
                let fix_fields_to_use = window['fix_fields_' + fix_ver.replace('.','')]
                self.parse_fix(escape_char, raw_fix, fix_fields_to_use)
            });
        });

        $("#clearButton").on('click', function () {
            $('#rawFix').val('')
        });

        $("#sampleButton").on('click', function () {
            $('#rawFix').val('8=FIX.4.2^A9=088^A35=0^A34=9523^A52=20210916-18:24:14^A49=41702TEST^A56=EPOPFIXTEST^A112=20210916-18:24:14.377^A10=139^A')
        });

    });
</script>
</body>
</html>